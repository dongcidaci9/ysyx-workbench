.DEFAULT_GOAL = all

all:
	@echo "Write this Makefile by your self."

# Top module
TOP_MODULE = ysyx_23060201_TOP

# --- 1. Some path variables ---

## Verilog source directory
VERILOG_SRC_DIR = vsrc
VERILOG_SRC = $(wildcard $(VERILOG_SRC_DIR)/*.v)

## Simulation main func source directory
SIM_SRC_DIR = csrc
SIM_SRC += $(wildcard $(SIM_SRC_DIR)/*.cpp)
SIM_SRC += $(wildcard $(SIM_SRC_DIR)/*.c)

## Object file directory
WORK_DIR = $(shell pwd)
VINC_DIR = $(WORK_DIR)/include/vsrc
CINC_DIR = $(WORK_DIR)/include/csrc
BUILD_DIR = $(WORK_DIR)/build

# --- 2. Compile and link flags ---

VERILATOR := verilator

## Verilog files compile flags
TOP_FLAGS := --top-module $(TOP_MODULE)
BUILD_FLAGS := --Mdir $(BUILD_DIR)
VINC_FLAGS := -I$(VINC_DIR)
VFLAGS := --timing -Wall -cc -build -exe -j 0 -trace 

## C/C++ files compile flags
COMPILE += -CFLAGS "-I$(CINC_DIR)" 

## Link flags
LIBS += -LDFLAGS "-lreadline"

# --- 4. Target file --- 
TARGET = $(VOBJ_DIR)/V$(TOP_MODULE)
$(TARGET): $(VERILOG_SRC) $(SIM_SRC)
	$(VERILATOR) $(TOP_FLAGS) $(BUILD_FLAGS) $(VINC_FLAGS) $(VFLAGS) $(VERILOG_SRC) \
	$(COMPILE) $(SIM_SRC) \
	$(LIBS)

WAVEFILE = $(WORK_DIR)/wave.vcd

BINARY = $(BUILD_DIR)/V$(TOP_MODULE)

IMG ?=
NPC_EXEC := $(BINARY) $(ARGS) $(IMG)

# --- 5. menuconfig ---
# Include rules for menuconfig 
include $(NPC_HOME)/scripts/config.mk

# Include variables and rules generated by menuconfig
-include $(NPC_HOME)/include/config/auto.conf
-include $(NPC_HOME)/include/config/auto.conf.cmd

# --- 6. filelists ---
FILELIST_MK = $(shell find -L ./csrc -name "filelist.mk")
#include $(FILELIST_MK)

# --- 7. Target command ---
sim: $(TARGET)
	$(call git_commit, "sim RTL") # DO NOT REMOVE THIS LINE!!!

wave: $(WAVEFILE)
	gtkwave $(WAVEFILE)

run: sim 
	$(call git_commit, "run NPC")
	$(NPC_EXEC) 
	
clean:
	-rm -rf $(BUILD_DIR) $(WAVEFILE)

.PHONY:
	all sim wave run wave clean

include ../Makefile
